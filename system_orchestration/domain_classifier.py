from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate

class DomainClassifier:
    """LLM 기반 도메인 분류기"""

    def __init__(self, model_name="gpt-4o-mini"):
        self.llm = ChatOpenAI(model=model_name)
        self.prompt = PromptTemplate.from_template("""
        너는 사회조사 분야의 전문가야.
        아래의 사용자 조사 요구사항과 일부 참조 설문 문서를 참고하여,
        이 설문이 속하는 주제 도메인을 판단해줘.
        선택지는 다음 중 하나야:

        [공공·사회 / 교육 / 산업·경제 / 의료·보건·복지 / 해당없음]

        ## 사용자 요구사항
        {user_input}

        ## 참조 설문 요약
        {context}

        ## 출력 형식 
        결과는 분류된 도메인명만 출력 
        
        ex1) 공공·사회
        ex2) 교육
        """)

    def classify(self, user_input: dict, context: str) -> str:
        formatted_input = self.prompt.format(
            user_input=str(user_input),
            context=context[:1000]  # 너무 길면 LLM이 산만해지므로 앞부분만
        )

        response = self.llm.invoke(formatted_input).content

        return response


user_input = {'조사목적': '병원의 조직문화 현황을 진단하고 개선 방향을 도출하기 위함', 
              '조사대상': '병원에 근무하는 의료진 및 일반 직원(행정·지원 포함)', 
              '주요측정변수': ['조직문화 전반 인식', '의사소통 및 정보공유', '팀워크와 협업', '리더십 및 상사 지원', '공정성·신뢰·존중', '업무환경 및 워크라이프밸런스', '직무만족과 조직몰입', '변화관리 수용도 및 개선 참여의향', '환자안전문화와 환자중심 가치', '개선 필요 영역 및 건의사항'], 
              '요청문항수': '10문항', 
              '설문요구사항': '설문지는 총 10 문항으로 구성할 것. 조사 대상은 병원 재직 의료진 및 직원으로 한정. 응답 척도·설문 방식 등 기타 세부 조건은 문서에 미명시.'}


context = '''
조사 개요 요약
- 목적: 의료원 내부 구성원(의료진·행정·지원 포함)의 조직문화 현황을 진단하고 개선 방안을 도출(직무만족·소통·노사관계·직장 내 괴롭힘 인식 등 포함)
- 구조:
  • 배경질문(성별, 고용형태, 근속, 직종/부서)
  • 본조사(조직문화 지원체계, 직무만족·불만족 원인·이직의도, 변화관리 방해요인·개선 필요, 노사관계 인식·공동노력, 직장 내 괴롭힘 인식/안전감, 자유의견)       
- 핵심 영역: 조직문화 전반 인식, 의사소통 및 정보공유, 공정성·신뢰·존중(직장 내 괴롭힘 관련), 직무만족과 조직몰입(이직의도), 변화관리 수용도·개선 참여의향, 개선 필요 영역 및 건의사항
- 추가 영역: 고충처리 지원체계(상사/조직 지원의 간접 측정), 노사공동 개선 노력 
- 비포함/제한적: 팀워크·협업, 업무환경·워크라이프밸런스, 환자안전문화·환자중심 가치는 본 원문 문항에 직접적 측정 문항이 없음
- 응답 형식: 객관식(단일/복수응답), 4점척도, 자유서술문항 혼합
- 조사 대상: 병원 재직 의료진 및 직원(내부고객)

핵심 문항 및 보기 예시
아래 10문항은 [병원 조직문화 개선을 위한 설문조사(대구가톨릭대학교의료원, 직원 고충처리위원회)] 원문에서 발췌·축약한 핵심 문항입니다. 문항 번호는 이해를 돕기 위한 재배열입니다.

Q1. 귀하는 근무하는 직장생활에 만족 하십니까?
① 예
② 아니오

Q2. [Q1에서 ‘아니오’ 응답자만] 귀하는 조직문화의 불만족 원인 중 가장 큰 이유는 무엇입니까? (2개 선택)
① 일방적 의사전달과 폐쇄적인 소통
② 수익성과 위주의 업무 시스템
③ 상부 조직의 구시대적 사고방식(ex: 나 때는 말이야...)
④ 체계와 서열 중시
⑤ 비효율적 업무관행
⑥ 혈연·지연·학연 중심의 인사
⑦ 기타 ( )

Q3. [Q1에서 ‘아니오’ 응답자만] 귀하는 본인 직장 내 조직문화의 불만족으로 이직을 생각한 적이 있습니까?
① 예 (사유: )
② 아니요

Q4. 귀하의 직장은 직원의 고민·불만·고충·갈등 등에 대해 소리함·직원고충처리위원 회 등으로 상담해주거나 해결을 위한 지원을 하고 있습니까?
① 상담 또는 해결을 위해 지원해준다.
② 상담 또는 해결을 위해 지원하지 않는다.
③ 상담 또는 해결을 위한 지원을 하는지 모르겠다.

Q5. 귀하는 조직문화를 개선하는데 있어 가장 큰 방해 요소는 무엇이라 생각합니까? (2개 선택)
① 변화의 필요성을 못 느낌
② 개선이 필요하지만 너무 오래 이어져 온 사내 악습
③ 조직의 분위기를 흐리는 몇몇 특정적인 인물들
④ 개방성·자율성을 용납하지 않는 조직분위기
⑤ 공공연하게 이루어지는 편 가르기
⑥ 기타 ( )

Q6. 귀하는 조직문화를 개선하기 위해 가장 필요한 것이 무엇이라 생각합니까? (2개 선택)
① 조직문화 개선을 위한 사례교육
② 보직 순환제 도입
③ 서열에 얽매이지 않는 편안한 관계 개선
④ 개방적 의사전달 및 소통경로
⑤ 기타 ( )

Q7. 귀하는 노사 관계가 조직문화에 영향을 미친다고 생각하십니까?
① 예
② 아니오

Q8. [Q7에서 ‘예’ 응답자만] 그렇다면 조직문화 개선을 위해 노사간 어떠한 노력이  필요하다고 생각하십니까? (2개 선택)
① 노사 공히 공정하고 투명한 정보의 제공
② 상호 호혜적 관계구축을 위한 신뢰와 소통
③ 직원 고충처리에 노사간 공동노력
④ 조직문화 개선을 위한 노사 공동 캠페인
⑤ 기타 ( )

Q9. 귀하는 귀하의 직장에서 직장 괴롭힘으로부터 얼마나 안전하다고 느끼십니까?   
① 매우 안전하다
② 어느 정도 안전하다
③ 별로 안전하지 않다
④ 전혀 안전하지 않다

Q10. 조직문화 개선을 위한 건의사항이 있다면 자유롭게 기술하시오. (첨부 가능)   

참고
- 상기 문항은 병원 재직 의료진 및 일반 직원(행정·지원 포함)을 대상으로 실시된  실제 설문에서 발췌했습니다.
- 사용자 요청 항목 중 ‘팀워크·협업’, ‘업무환경/워크라이프밸런스’, ‘환자안전문화·환자중심 가치’는 원문 설문에 직접 문항이 없어 포함되지 않았습니다. 해당 영역  포함이 필요하면 별도 문항 추가가 필요합니다.
'''


if __name__ == "__main__":
    domain_classifier = DomainClassifier()
    selected_domain = domain_classifier.classify(user_input, context)
    print(selected_domain)